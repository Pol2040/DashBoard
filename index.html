<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard RRSS ObSBA</title>

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e9ecef;
      margin: 0;
      padding: 30px;
      color: #343a40;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: auto;
      background: #ffffff;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    h1 {
      color: #4e73df;
      border-bottom: 3px solid #4e73df;
      padding-bottom: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .controls {
      display:flex;
      gap: 24px;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px;
      background:#f8f9fa;
      border-radius:10px;
    }
    .controls label { font-weight:700; color:#6c757d; margin-right:8px; }
    .controls select {
      padding:10px 14px;
      border:2px solid #ced4da;
      border-radius:8px;
      background:#fff;
      min-width:260px;
      font-size:1rem;
    }
    .controls select:focus {
      border-color:#4e73df;
      box-shadow:0 0 0 0.2rem rgba(78,115,223,0.15);
      outline:none;
    }

    .chart-card {
      background:#fff;
      border:1px solid #e3e6f0;
      border-radius:8px;
      padding:20px;
      margin-top:20px;
      box-shadow:0 0 15px rgba(0,0,0,0.05);
    }
    .card-title { text-align:center; color:#4e73df; font-weight:700; font-size:1.25rem; margin-bottom:12px; }
    #chart_area { width:100%; height:520px; }
    .info { text-align:center; color:#e74a3b; margin-top:12px; }
    pre.link { background:#f1f3f5; padding:10px; border-radius:6px; overflow:auto; font-size:0.9rem; }
    .footer-note { font-size:0.9rem; color:#6c757d; text-align:center; margin-top:12px; }
  </style>
</head>
<body>
  <div class="dashboard-container">
  <h1>Dashboard RRSS ObSBA</h1>

    <div class="controls">
      <div>
        <label for="socialSelect">Red social:</label><br/>
        <select id="socialSelect"></select>
      </div>

      <div>
        <label for="chartSelect">Gráfico:</label><br/>
        <select id="chartSelect"></select>
      </div>
    </div>

    <div class="chart-card">
      <div class="card-title" id="cardTitle">Seleccione una red y un gráfico</div>
      <div id="chart_area">Cargando...</div>
      <div id="chartInfo" class="info"></div>
    </div>
  </div>

<script>
/* ========== CONFIG: GIDs y mapeo de gráficos (basado en tu input) ========== */
const SHEET_ID = '17nld9mh3PtcOSPkKU2VxFGIkUD3w8IaZ1VyuR2XhtN8';

const SHEETS = {
  "General": { gid: "936287352", label: "HomePage" },
  "Instagram": { gid: "2147310482", label: "Instagram" },
  "Facebook": { gid: "708910305", label: "Facebook" },
  "X": { gid: "1309548050", label: "X" },
  "TikTok": { gid: "650301486", label: "TikTok" },
  "YouTube": { gid: "398717676", label: "YouTube" }
};
const CHARTS_BY_SHEET = {
  "General": {
    "promedios": {
      label: "Promedios generales",
      query: 'SELECT A, B, C, D  WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año"',
      chartType: 'ColumnChart'
    }
  },

  "Instagram": {
    "anual": {
      label: "Tasa de compromiso total",
      query: 'SELECT A, B, C, D  WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año"',
      chartType: 'ColumnChart'
    },
    "bimestral": {
      label: "Tasa de compromiso por bimestres",
query: `SELECT H, I, J, K, L, M, N
  WHERE H IS NOT NULL AND (I IS NOT NULL OR J IS NOT NULL OR K IS NOT NULL OR L IS NOT NULL OR M IS NOT NULL OR N IS NOT NULL)
  LABEL H 'Año'`,
      chartType: 'ColumnChart'
    },
    "tipo_post": {
      label: "Anual. Por tipo de publicación",
      query: 'SELECT E, F, G  WHERE E IS NOT NULL AND (F IS NOT NULL OR G IS NOT NULL) LABEL E "Año"',
      chartType: 'ColumnChart'
    },    
    "Top_Anual": {
      label: "Top publicaciones anuales",
      query: 'SELECT P, Q  WHERE P IS NOT NULL AND (Q IS NOT NULL) LABEL P "Top"',
      chartType: 'ColumnChart'
    },    
    "Top_Bimestral": {
      label: "Top publicaciones Bimestrales",
      query: 'SELECT S, T, U, V  WHERE S IS NOT NULL AND (T IS NOT NULL OR U IS NOT NULL OR V IS NOT NULL) LABEL S "Bimestre"',
      chartType: 'ColumnChart'
    }
  },

  "Facebook": {
    "anual": {
      label: "Tasa de compromiso total",
      query: 'SELECT A, B, C, D  WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A "Año"',
      chartType: 'ColumnChart'
    },
    "bimestral": {
      label: "Tasa de compromiso por bimestres.",
     query: `SELECT I, J, K, L, M, N, O WHERE I IS NOT NULL AND (J IS NOT NULL OR K IS NOT NULL OR L IS NOT NULL OR M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL) LABEL I 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "tipo_post": {
      label: "Facebook anual. Por tipo de publicación",
      query: 'SELECT E, F, G, H  WHERE E IS NOT NULL AND (F IS NOT NULL OR G IS NOT NULL OR H IS NOT NULL) LABEL E "Año"',
      chartType: 'ColumnChart'
    },
        "Top_Anual": {
      label: "Top publicaciones anuales",
      query: 'SELECT P, Q  WHERE P IS NOT NULL AND (Q IS NOT NULL) LABEL P "Top"',
      chartType: 'ColumnChart'
    },    
    "Top_Bimestral": {
      label: "Top publicaciones Bimestrales",
      query: 'SELECT S, T, U, V  WHERE S IS NOT NULL AND (T IS NOT NULL OR U IS NOT NULL OR V IS NOT NULL) LABEL S "Bimestre"',
      chartType: 'ColumnChart'
    }
  },
  "X": {
    "anual": {
      label: "Tasa de compromiso total",
      query: `SELECT A, B, C, D WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A 'Año'`,
      chartType: 'ColumnChart'
    },
    "bimestral": {
      label: "Tasa de compromiso por bimestres",
     query: `SELECT J, K, L, M, N, O, P WHERE J IS NOT NULL AND (K IS NOT NULL OR L IS NOT NULL OR M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL OR P IS NOT NULL) LABEL J 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "bimestres_tipo_2025": {
      label: "2025: TC por bimestres y tipo",
      query: `SELECT R, S, T WHERE R IS NOT NULL AND (S IS NOT NULL OR T IS NOT NULL) LABEL R 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "tipo_por_anio": {
      label: "TC por año y tipo",
      query: `SELECT F, G, H WHERE F IS NOT NULL AND (G IS NOT NULL OR H IS NOT NULL) LABEL F 'Año'`,
      chartType: 'ColumnChart'
    },
        "Top_Anual": {
      label: "Top publicaciones anuales",
      query: 'SELECT W, X  WHERE W IS NOT NULL AND (X IS NOT NULL) LABEL W "Top"',
      chartType: 'ColumnChart'
    },    
    "Top_Bimestral": {
      label: "Top publicaciones Bimestrales",
      query: 'SELECT Z, AA, AB, AC  WHERE Z IS NOT NULL AND (AA IS NOT NULL OR AB IS NOT NULL OR AC IS NOT NULL) LABEL Z "Bimestre"',
      chartType: 'ColumnChart'
    }
  },
  "TikTok": {
    "anual": {
      label: "Tasa de compromiso total",
      query: `SELECT A, B, C, D WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL OR D IS NOT NULL) LABEL A 'Año'`,
      chartType: 'ColumnChart'
    },
    "bimestral": {
      label: "Tasa de compromiso. Visualizaciones. Bimestral",
      query: `SELECT K, L, M, N, O, P, Q WHERE K IS NOT NULL AND (L IS NOT NULL OR M IS NOT NULL OR N IS NOT NULL OR O IS NOT NULL OR P IS NOT NULL OR Q IS NOT NULL) LABEL K 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "bimestres_tipo": {
      label: "Tasa de compromiso. Por bimestres",
      query: `SELECT S, T, U, V WHERE S IS NOT NULL AND (T IS NOT NULL OR U IS NOT NULL OR V IS NOT NULL) LABEL S 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "tipo_x_anio": {
      label: "Anual. Por tipo de publicación",
      query: `SELECT F, G, H, I WHERE F IS NOT NULL AND (G IS NOT NULL OR H IS NOT NULL OR I IS NOT NULL) LABEL F 'Año'`,
      chartType: 'ColumnChart'
    },
        "Top_Anual": {
      label: "Top publicaciones anuales",
      query: 'SELECT P, Q  WHERE P IS NOT NULL AND (Q IS NOT NULL) LABEL P "Top"',
      chartType: 'ColumnChart'
    },    
    "Top_Bimestral": {
      label: "Top publicaciones Bimestrales",
      query: 'SELECT S, T, U, V  WHERE S IS NOT NULL AND (T IS NOT NULL OR U IS NOT NULL OR V IS NOT NULL) LABEL S "Bimestre"',
      chartType: 'ColumnChart'
    },
    "Top_Anual": {
      label: "Top publicaciones anuales",
      query: 'SELECT X ,Y WHERE X IS NOT NULL AND (Y IS NOT NULL) LABEL X "Top"',
      chartType: 'ColumnChart'
    },    
    "Top_Bimestral": {
      label: "Top publicaciones Bimestrales",
      query: 'SELECT AA, AB, AC,AD  WHERE AA IS NOT NULL AND (AB IS NOT NULL OR AC IS NOT NULL OR AD IS NOT NULL) LABEL AA "Bimestre"',
      chartType: 'ColumnChart'
    }
  },
  "YouTube": {
    "anual": {
      label: "Tasa de compromiso total",
      query: `SELECT A, B, C WHERE A IS NOT NULL AND (B IS NOT NULL OR C IS NOT NULL) LABEL A 'Año'`,
      chartType: 'ColumnChart'
    },
    "bimestral": {
      label: "Tasa de compromiso total. Por bimestres",
      query: `SELECT P, Q, R, S, T, U, V WHERE P IS NOT NULL AND (Q IS NOT NULL OR R IS NOT NULL OR S IS NOT NULL OR T IS NOT NULL OR U IS NOT NULL OR V IS NOT NULL) LABEL P 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "tc_shorts_anual": {
      label: "Tasa de compromiso en SHORTS",
      query: `SELECT D, E, F WHERE D IS NOT NULL AND (E IS NOT NULL OR F IS NOT NULL) LABEL D 'Año'`,
      chartType: 'ColumnChart'
    },
    "tc_video_anual": {
      label: "Tasa de compromiso en VIDEOS",
      query: `SELECT J, K, L WHERE J IS NOT NULL AND (K IS NOT NULL OR L IS NOT NULL) LABEL J 'Año'`,
      chartType: 'ColumnChart'
    },
    "tc_shorts_bimestral": {
      label: "Tasa de compromiso en SHORTS. Por bimestres",
      query: `SELECT W, X, Y, Z, AA, AB, AC WHERE W IS NOT NULL AND (X IS NOT NULL OR Y IS NOT NULL OR Z IS NOT NULL OR AA IS NOT NULL OR AB IS NOT NULL OR AC IS NOT NULL) LABEL W 'Bimestre'`,
      chartType: 'ColumnChart'
    },
    "tipo_x_anio": {
      label: "Tasa de compromiso total por tipo de publicación",
     query: `SELECT G, H, I WHERE G IS NOT NULL AND (H IS NOT NULL OR I IS NOT NULL) LABEL G 'Año'`,
      chartType: 'ColumnChart'
    },
    "tc_2025_bimestres_tipo": {
      label: "Tasa de compromiso 2025. Por bimestres",
      query: `SELECT M, N, O WHERE M IS NOT NULL AND (N IS NOT NULL OR O IS NOT NULL) LABEL M 'Bimestre'`,
      chartType: 'ColumnChart'
    },        
    "Top_Anual": {
      label: "Top publicaciones anuales",
      query: 'SELECT AE, AF  WHERE AE IS NOT NULL AND (AF IS NOT NULL) LABEL AE "Top"',
      chartType: 'ColumnChart'
    },    
    "Top_Bimestral": {
      label: "Top publicaciones Bimestrales",
      query: 'SELECT AH, AI, AJ, AK  WHERE AH IS NOT NULL AND (AI IS NOT NULL OR AJ IS NOT NULL OR AK IS NOT NULL) LABEL AH "Bimestre"',
      chartType: 'ColumnChart'
    }
  }
};

/* === colores por series (coincidir con tu paleta) === */
const COLORS = ['#4e73df','#9c27b0','#28a745','#f6c23e','#e74a3b','#fd7e14','#6f42c1','#3b5998','#ff0000','#000000'];

/* ========== Inicializar Google Charts ========== */
google.charts.load('current', {packages:['corechart']});
google.charts.setOnLoadCallback(initUI);

/* ========== UI bootstrap ========== */
function initUI() {
  const socialSelect = document.getElementById('socialSelect');
  const chartSelect = document.getElementById('chartSelect');

  // llenar socialSelect
  Object.keys(SHEETS).forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.text = SHEETS[k].label || k;
    socialSelect.appendChild(opt);
  });

  // evento cambios
  socialSelect.addEventListener('change', () => populateChartsFor(socialSelect.value));
  chartSelect.addEventListener('change', () => loadSelectedChart());

  // seleccion por defecto
socialSelect.value = "General";
populateChartsFor("General");
}

/* Llena chartSelect según social */
function populateChartsFor(socialKey) {
  const chartSelect = document.getElementById('chartSelect');
  chartSelect.innerHTML = '';

  const charts = CHARTS_BY_SHEET[socialKey] || {};
  Object.keys(charts).forEach(key => {
    const opt = document.createElement('option');
    opt.value = key;
    opt.text = charts[key].label;
    chartSelect.appendChild(opt);
  });

  // set card title and load first chart
  const first = chartSelect.options[0]?.value;
  if (first) chartSelect.value = first;
  document.getElementById('cardTitle').textContent = `${SHEETS[socialKey].label} — ${charts[first]?.label || ''}`;
  loadSelectedChart();
}

/* Construye URL de consulta y carga datos */
function loadSelectedChart() {
  const social = document.getElementById('socialSelect').value;
  const chartKey = document.getElementById('chartSelect').value;
  const chartCfg = CHARTS_BY_SHEET[social] && CHARTS_BY_SHEET[social][chartKey];

  const infoDiv = document.getElementById('chartInfo');
  const chartArea = document.getElementById('chart_area');

  if (!chartCfg) {
    chartArea.innerHTML = 'No hay configuración para este gráfico.';
    return;
  }

  document.getElementById('cardTitle').textContent = `${SHEETS[social].label} — ${chartCfg.label}`;
  infoDiv.textContent = '';

  // construir URL para el query (usamos tqx=out:json)
  const gid = SHEETS[social].gid;
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}&tqx=out:json&tq=${encodeURIComponent(chartCfg.query)}`;

  chartArea.innerHTML = 'Cargando gráfico...';

  fetch(url)
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    })
    .then(text => {
      const m = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/);
      if (!m) {
        chartArea.innerHTML = '<span style="color:#b00;font-weight:700;">Error: no se pudo parsear la respuesta.</span>';
        console.error('Respuesta cruda:', text.slice(0,300));
        return;
      }
      const json = JSON.parse(m[1]);

      if (!json.table || !Array.isArray(json.table.cols) || json.table.cols.length === 0) {
        chartArea.innerHTML = `<span style="color:#b00;font-weight:700;">La hoja no devolvió columnas (revise el rango/query).</span>`;
        console.warn('json.table:', json.table);
        return;
      }

      // crear DataTable a partir de json.table
   let dataTable = new google.visualization.DataTable(json.table);

// --- FORZAR primera columna como TEXTO (evita 2,025.0) ---
if (dataTable.getNumberOfRows() > 0) {
    const firstColType = dataTable.getColumnType(0);
    if (firstColType === 'number') {
        // Crear nueva DataTable clonando estructura pero cambiando primera columna a string
        const newTable = new google.visualization.DataTable();
        
        // Primera columna como string
        newTable.addColumn('string', dataTable.getColumnLabel(0));

        // Resto igual que original
        for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
            newTable.addColumn(dataTable.getColumnType(c), dataTable.getColumnLabel(c));
        }

        // Copiar datos, convirtiendo primera columna a texto
        for (let r = 0; r < dataTable.getNumberOfRows(); r++) {
            const row = [];
            row.push(String(dataTable.getValue(r, 0))); // <-- convertimos a STRING
            for (let c = 1; c < dataTable.getNumberOfColumns(); c++) {
                row.push(dataTable.getValue(r, c));
            }
            newTable.addRow(row);
        }

        dataTable = newTable; // <-- reasignamos
    }
}

/* ███ RECONSTRUCCIÓN DE TABLA CON ANNOTATIONS ███ */

// 1. Crear una nueva tabla vacía
let newTable = new google.visualization.DataTable();

// 2. Copiar la columna 0 (normalmente el eje X)
newTable.addColumn(
  dataTable.getColumnType(0),
  dataTable.getColumnLabel(0)
);

// 3. Para cada columna numérica, duplicarla con annotation al lado
for (let col = 1; col < dataTable.getNumberOfColumns(); col++) {
  let type = dataTable.getColumnType(col);

  // copiar columna original
  newTable.addColumn(type, dataTable.getColumnLabel(col));

  // si es numérica → agregar annotation
  if (type === "number") {
    newTable.addColumn({ type: "string", role: "annotation" });
  }
}

// 4. Copiar datos fila por fila con annotations
for (let row = 0; row < dataTable.getNumberOfRows(); row++) {
  let rowValues = [];

  // columna 0 tal cual
  rowValues.push(dataTable.getValue(row, 0));

  for (let col = 1; col < dataTable.getNumberOfColumns(); col++) {
    let value = dataTable.getValue(row, col);
    rowValues.push(value);

    // si es numérica → agregar annotation
    if (dataTable.getColumnType(col) === "number") {
      let formatted = (value !== null && !isNaN(value))
        ? value.toLocaleString("es-ES", { maximumFractionDigits: 2 })
        : "";
      rowValues.push(formatted);
    }
  }

  newTable.addRow(rowValues);
}

// reemplazar dataTable por la tabla nueva
dataTable = newTable;

/* ███ FIN RECONSTRUCCIÓN ███ */

      
      // detectamos si la primera columna es label (string) o numérica
      const firstColType = dataTable.getColumnType(0); // 'string'|'number' etc
      let chartObj;
      const chartType = chartCfg.chartType || 'ColumnChart';
      const options = buildOptions(chartCfg.label, dataTable.getNumberOfColumns()-1);

      // elegir el chart según chartType
      if (chartType === 'LineChart') {
        chartObj = new google.visualization.LineChart(document.getElementById('chart_area'));
      } else if (chartType === 'BarChart') {
        chartObj = new google.visualization.BarChart(document.getElementById('chart_area'));
      } else {
        chartObj = new google.visualization.ColumnChart(document.getElementById('chart_area'));
      }
      
      // asignar colores por dataset
      const seriesColors = COLORS.slice(0, Math.max(1, dataTable.getNumberOfColumns()- (firstColType === 'string' ? 1 : 0)));
      options.colors = seriesColors;

      try {
        chartObj.draw(dataTable, options);
        infoDiv.textContent = '';
      } catch(err) {
        chartArea.innerHTML = `<span style="color:#b00;font-weight:700;">Error al dibujar el gráfico: ${err.message}</span>`;
        console.error(err);
      }
    })
    .catch(err => {
      chartArea.innerHTML = `<span style="color:#b00;font-weight:700;">Error: ${err.message}</span>`;
      console.error(err);
    });
    
}

/* Construye options estéticos coherentes con tu dashboard */
function buildOptions(title, seriesCount) {
  return {
    title: title,
    titleTextStyle: { color: "#4e73df", fontSize: 18, bold: true },
    chartArea: { left: 70, top: 60, right: 30, bottom: 80, width:'80%', height:'65%' },

    legend: { position: 'bottom', textStyle: { fontSize: 12 } },

    hAxis: {
      textStyle: { fontSize: 12 },
      gridlines: { color: '#eef0f4' }
    },

    vAxis: {
      textStyle: { fontSize: 12 },
      gridlines: { color: '#e3e6f0' }
    },

    animation: { startup: true, duration: 600, easing: 'out' },

    seriesType: 'bars',

    annotations: {
      alwaysOutside: true,
      textStyle: {
        fontSize: 12,
        bold: true,
        //color: '#000'
      }
    }
  };
}
</script>
</body>
</html>
